# Configuration reference:
# https://www.runatlantis.io/docs/server-side-repo-config.html#example-server-side-repo
#
# Usage:
# https://www.runatlantis.io/docs/using-atlantis.html#atlantis-help

repos:
- id: /.*/
  apply_requirements: [approved, mergeable]
  allowed_overrides: [apply_requirements, workflow]
  allow_custom_workflows: false

workflows:
  dev:
    plan:
      steps:
      # We have to use a custom run step to rm -rf .terraform because otherwise
      # Terraform will complain in-between commands since the backend config has
      # changed.
      - run: rm -rf .terraform
      - init:
          extra_args: ["-backend-config", "env/dev.hcl", "-reconfigure"]
      - plan:
          extra_args: ["-var-file", "env/dev.tfvars"]
    apply:
      steps:
      - apply:
          extra_args: ["-var-file", "env/dev.tfvars"]

  qa:
    plan:
      steps:
      # We have to use a custom run step to rm -rf .terraform because otherwise
      # Terraform will complain in-between commands since the backend config has
      # changed.
      - run: rm -rf .terraform
      - init:
          extra_args: ["-backend-config", "env/qa.hcl", "-reconfigure"]
      - plan:
          extra_args: ["-var-file", "env/qa.tfvars"]
    apply:
      steps:
      - apply:
          extra_args: ["-var-file", "env/qa.tfvars"]
